<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>杜岳潼的AI分身</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#07C160', // 微信绿
                        secondary: '#E5E5EA',
                        tertiary: '#F2F2F7',
                        textDark: '#1D1D1F',
                        textLight: '#8E8E93',
                        bubbleUser: '#07C160',
                        bubbleAI: '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-in-out',
                        'pulse-recording': 'pulseRecording 1.5s infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pulseRecording: {
                            '0%': { transform: 'scale(1)', opacity: '1' },
                            '50%': { transform: 'scale(1.1)', opacity: '0.7' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                    },
                    boxShadow: {
                        'modal': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .avatar-circle {
                border-radius: 50%;
                object-fit: cover;
            }
            .avatar-square {
                border-radius: 8px;
                object-fit: cover;
            }
            .message-bubble {
                max-width: 80%;
                padding: 10px 16px;
                border-radius: 18px;
                margin-bottom: 8px;
                position: relative;
                word-break: break-word;
            }
            .message-bubble-user {
                background-color: theme('colors.bubbleUser');
                color: white;
                border-bottom-right-radius: 4px;
                align-self: flex-end;
            }
            .message-bubble-ai {
                background-color: theme('colors.bubbleAI');
                color: theme('colors.textDark');
                border-bottom-left-radius: 4px;
                align-self: flex-start;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            .message-timestamp {
                font-size: 10px;
                margin-top: 4px;
                opacity: 0.7;
                text-align: right;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-textDark min-h-screen">
    <!-- 设置窗口 -->
    <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in">
        <div class="bg-white rounded-lg shadow-modal w-full max-w-md mx-4 overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-center mb-6">你更喜欢称呼杜岳潼的</h2>
                
                <!-- AI名字设置 -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">名字</label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button id="btnChineseName" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                            中文名字 (杜岳潼)
                        </button>
                        <button id="btnEnglishName" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                            英文名字 (Bowen)
                        </button>
                        <button id="btnCustomName" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                            自定义昵称
                        </button>
                    </div>
                    <div id="customNameContainer" class="hidden">
                        <input type="text" id="customNameInput" placeholder="输入自定义昵称" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>
                
                
                
                <!-- 开始聊天按钮 -->
                <button id="btnStartChat" class="w-full py-3 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center">
                    开始聊天
                    <i class="fa fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 聊天界面 -->
    <div id="chatInterface" class="hidden h-screen flex flex-col max-w-md mx-auto bg-white shadow-lg">
        <!-- 提示信息 -->
        <div class="bg-yellow-50 text-yellow-700 px-4 py-2 text-xs flex items-center justify-center sticky top-0 z-20">
            <i class="fa fa-info-circle mr-1"></i>
            <span>窗口关闭后，AI人格和聊天记录将消失，请珍惜使用</span>
        </div>
        <!-- 聊天头部 -->
        <div class="border-b border-gray-200 p-4 flex items-center justify-between bg-white sticky top-10 z-10">
            <div class="flex items-center">
                <div id="chatAvatar" class="w-10 h-10 rounded-full overflow-hidden mr-3">
                    <img src="image/touxiang.png" 
                         alt="AI头像" class="w-full h-full object-cover">
                </div>
                <div>
                    <h3 id="chatName" class="font-medium">杜岳潼</h3>
                    <p class="text-xs text-gray-500">在线</p>
                </div>
            </div>
        </div>
        
        <!-- 消息区域 -->
        <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto scrollbar-hide bg-gray-50 flex flex-col">
        </div>
        
        <!-- 输入区域 -->
        <div class="border-t border-gray-200 p-4 bg-white sticky bottom-0">
            <div class="flex items-center gap-2">
                <!-- 语音输入按钮 -->
                <button id="btnVoiceInput" class="text-gray-500 hover:text-primary transition-colors">
                    <i class="fa fa-microphone text-xl"></i>
                </button>
                <div class="relative flex-1">
                    <input type="text" id="messageInput" placeholder="输入消息..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <button id="btnSend" class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center hover:bg-opacity-90 transition-colors">
                    <i class="fa fa-paper-plane"></i>
                </button>
            </div>
            <!-- 语音识别状态显示 -->
            <div id="voiceStatus" class="hidden mt-2 text-center">
                <div id="voiceStatusText" class="text-sm text-gray-600"></div>
                <div id="voiceWave" class="flex justify-center mt-1 space-x-1 hidden">
                    <div class="w-1 h-4 bg-primary rounded-full animate-pulse-recording"></div>
                    <div class="w-1 h-6 bg-primary rounded-full animate-pulse-recording" style="animation-delay: 0.2s"></div>
                    <div class="w-1 h-4 bg-primary rounded-full animate-pulse-recording" style="animation-delay: 0.4s"></div>
                    <div class="w-1 h-6 bg-primary rounded-full animate-pulse-recording" style="animation-delay: 0.6s"></div>
                    <div class="w-1 h-4 bg-primary rounded-full animate-pulse-recording" style="animation-delay: 0.8s"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API配置
        const API_URL = 'https://api.modelarts-maas.com/v1/chat/completions';
        const MODEL_NAME = 'deepseek-v3.2-exp';
        const API_KEY = 'HEtGqbA-Td1uXAaB6LmvsWIG_cqOLpebxxhOYAAnl9zKwlCjA_K1EYDaPpzDz3YgJGWDXAUWZe6LJerFtlVjXQ';
        
        // 百度语音识别配置
        const BAIDU_APP_ID = '7187093';
        const BAIDU_API_KEY = 'fgF3kvYhDVpwzxaPOiTkdgNk';
        const BAIDU_SECRET_KEY = 'yjd7eOMLPLOY0Qgy5BZnuIkbnAyUzHF3';
        const BAIDU_ASR_URL = 'https://vop.baidu.com/pro_api'; // 百度语音识别API地址
        
        // 全局变量
        let aiName = '杜岳潼'; // 默认使用中文名字
        let aiAvatar = 'image/touxiang.png'; // 默认头像路径
        let avatarShape = 'circle'; // 固定为圆形
        let messageHistory = []; // 存储消息历史，用于多轮对话
        let aiPreset = ''; // 将从文件加载
        
        // 语音识别相关变量
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let accessToken = null;
        
        // DOM 元素
        const setupModal = document.getElementById('setupModal');
        const chatInterface = document.getElementById('chatInterface');
        const btnEnglishName = document.getElementById('btnEnglishName');
        const btnChineseName = document.getElementById('btnChineseName');
        const btnCustomName = document.getElementById('btnCustomName');
        const customNameContainer = document.getElementById('customNameContainer');
        const customNameInput = document.getElementById('customNameInput');
        const btnStartChat = document.getElementById('btnStartChat');
        const chatAvatar = document.getElementById('chatAvatar');
        const chatName = document.getElementById('chatName');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const btnSend = document.getElementById('btnSend');
        const btnVoiceInput = document.getElementById('btnVoiceInput');
        const voiceStatus = document.getElementById('voiceStatus');
        const voiceStatusText = document.getElementById('voiceStatusText');
        const voiceWave = document.getElementById('voiceWave');
        
        // 初始化：加载AI预设
        async function loadAiPreset() {
            try {
                const response = await fetch('ai-preset.txt');
                if (!response.ok) {
                    throw new Error('文件加载失败');
                }
                aiPreset = await response.text();
                console.log('AI预设加载成功');
            } catch (error) {
                console.error('加载AI预设失败:', error);
                // 如果文件加载失败，使用一个简短的默认值
                aiPreset = '你现在扮演杜岳潼的角色，请以他的身份进行对话。';
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAiPreset();
            // 获取百度语音识别的访问令牌
            getBaiduAccessToken();
        });
        
        // 获取百度语音识别访问令牌
        async function getBaiduAccessToken() {
            try {
                const response = await fetch(`https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${BAIDU_API_KEY}&client_secret=${BAIDU_SECRET_KEY}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('获取访问令牌失败');
                }
                
                const data = await response.json();
                accessToken = data.access_token;
                console.log('百度语音识别访问令牌获取成功');
            } catch (error) {
                console.error('获取百度语音识别访问令牌失败:', error);
            }
        }
        
        // 名字选择按钮事件
        btnEnglishName.addEventListener('click', () => {
            aiName = 'Bowen';
            updateNameButtons(btnEnglishName);
            customNameContainer.classList.add('hidden');
        });
        
        btnChineseName.addEventListener('click', () => {
            aiName = '杜岳潼';
            updateNameButtons(btnChineseName);
            customNameContainer.classList.add('hidden');
        });
        
        btnCustomName.addEventListener('click', () => {
            updateNameButtons(btnCustomName);
            customNameContainer.classList.remove('hidden');
            customNameInput.focus();
        });
        
        // 自定义名字输入事件
        customNameInput.addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                aiName = e.target.value.trim();
            }
        });
        
        
        
        // 开始聊天按钮事件
        btnStartChat.addEventListener('click', () => {
            setupModal.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            
            // 更新聊天界面的头像和名字
            chatName.textContent = aiName;
            chatAvatar.innerHTML = `<img src="${aiAvatar}" alt="${aiName}" class="w-full h-full object-cover">`;
            chatAvatar.className = 'w-10 h-10 rounded-full overflow-hidden mr-3'; // 固定为圆形
            
            // 清除消息历史
            messageHistory = [];
            
            // 清除消息区域
            messagesContainer.innerHTML = '';
            
            // 添加欢迎消息（符合角色设定）
            const welcomeMessage = `嗨，我是${aiName}。网上聊天我比较自在，有什么想聊的吗？`;
            addMessage(welcomeMessage, 'ai');
            
            // 添加欢迎消息到历史记录
            messageHistory.push({
                role: 'assistant',
                content: welcomeMessage
            });
            
            // 聚焦到输入框
            messageInput.focus();
        });
        
        
        
        // 发送按钮事件
        btnSend.addEventListener('click', sendMessage);
        
        // 输入框回车事件
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 语音输入按钮事件
        btnVoiceInput.addEventListener('click', toggleVoiceInput);
        
        // 辅助函数
        function updateNameButtons(activeButton) {
            const buttons = [btnEnglishName, btnChineseName, btnCustomName];
            buttons.forEach(btn => {
                if (btn === activeButton) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }
        
        // 语音输入功能
        async function toggleVoiceInput() {
            if (isRecording) {
                stopRecording();
            } else {
                await startRecording();
            }
        }
        
        // 开始录音
        async function startRecording() {
            try {
                // 请求麦克风权限
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // 创建MediaRecorder实例
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                // 收集音频数据
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                // 录音结束时的处理
                mediaRecorder.onstop = async () => {
                    // 创建Blob对象
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    // 停止所有音频轨道
                    stream.getTracks().forEach(track => track.stop());
                    
                    // 语音识别
                    await speechToText(audioBlob);
                    
                    // 重置状态
                    isRecording = false;
                    updateVoiceUI(false);
                };
                
                // 开始录音
                mediaRecorder.start();
                isRecording = true;
                updateVoiceUI(true);
                
            } catch (error) {
                console.error('无法访问麦克风:', error);
                alert('无法访问麦克风，请确保已授予麦克风权限。');
                updateVoiceUI(false);
            }
        }
        
        // 停止录音
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
            }
        }
        
        // 更新语音输入UI状态
        function updateVoiceUI(recording) {
            if (recording) {
                // 录音中状态
                btnVoiceInput.innerHTML = '<i class="fa fa-stop text-xl"></i>';
                btnVoiceInput.classList.remove('text-gray-500', 'hover:text-primary');
                btnVoiceInput.classList.add('text-red-500', 'hover:text-red-600');
                
                voiceStatusText.textContent = '正在录音... 点击停止';
                voiceWave.classList.remove('hidden');
                voiceStatus.classList.remove('hidden');
            } else {
                // 非录音状态
                btnVoiceInput.innerHTML = '<i class="fa fa-microphone text-xl"></i>';
                btnVoiceInput.classList.remove('text-red-500', 'hover:text-red-600');
                btnVoiceInput.classList.add('text-gray-500', 'hover:text-primary');
                
                voiceStatusText.textContent = '';
                voiceWave.classList.add('hidden');
                voiceStatus.classList.add('hidden');
            }
        }
        
        // 语音转文字
        async function speechToText(audioBlob) {
            if (!accessToken) {
                console.error('百度语音识别访问令牌未获取');
                voiceStatusText.textContent = '语音识别服务未就绪，请稍后再试';
                setTimeout(() => {
                    voiceStatus.classList.add('hidden');
                }, 3000);
                return;
            }
            
            voiceStatusText.textContent = '正在识别语音...';
            voiceWave.classList.add('hidden');
            
            try {
                // 将音频Blob转换为Base64
                const base64Audio = await blobToBase64(audioBlob);
                
                // 准备请求数据
                const formData = new FormData();
                formData.append('speech', base64Audio.split(',')[1]); // 移除Base64前缀
                formData.append('format', 'wav');
                formData.append('rate', 16000); // 采样率
                formData.append('channel', 1); // 单声道
                formData.append('cuid', 'web_chat_app');
                formData.append('token', accessToken);
                formData.append('dev_pid', 1537); // 普通话(支持简单的英文识别)
                
                // 发送语音识别请求
                const response = await fetch(BAIDU_ASR_URL, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`语音识别请求失败: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.err_no === 0) {
                    // 识别成功
                    const recognizedText = result.result[0];
                    messageInput.value = recognizedText;
                    voiceStatusText.textContent = '识别完成';
                    
                    // 自动聚焦到输入框
                    messageInput.focus();
                    
                    // 2秒后隐藏状态提示
                    setTimeout(() => {
                        voiceStatus.classList.add('hidden');
                    }, 2000);
                    
                } else {
                    // 识别失败
                    throw new Error(`语音识别错误: ${result.err_msg}`);
                }
                
            } catch (error) {
                console.error('语音识别失败:', error);
                voiceStatusText.textContent = '语音识别失败，请重试';
                
                // 3秒后隐藏状态提示
                setTimeout(() => {
                    voiceStatus.classList.add('hidden');
                }, 3000);
            }
        }
        
        // 将Blob转换为Base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // 添加用户消息
            addMessage(message, 'user');
            messageInput.value = '';
            
            // 添加到消息历史
            messageHistory.push({
                role: 'user',
                content: message
            });
            
            // 显示加载状态
            const loadingId = showLoading();
            
            // 调用API获取AI回复
            callApi(message)
                .then(response => {
                    // 移除加载状态
                    removeLoading(loadingId);
                    
                    // 添加AI回复
                    addMessage(response, 'ai');
                    
                    // 添加到消息历史
                    messageHistory.push({
                        role: 'assistant',
                        content: response
                    });
                })
                .catch(error => {
                    // 移除加载状态
                    removeLoading(loadingId);
                    
                    // 显示错误消息
                    addMessage('抱歉，API调用失败，请稍后再试。', 'ai');
                    console.error('API调用失败:', error);
                });
        }
        
        // 调用API获取AI回复
        async function callApi(message) {
            // 检查aiPreset是否已加载
            if (!aiPreset) {
                console.warn('AI预设尚未加载完成，等待中...');
                // 等待一小段时间再重试
                await new Promise(resolve => setTimeout(resolve, 100));
                if (!aiPreset) {
                    throw new Error('AI预设加载失败，请刷新页面重试');
                }
            }
            
            // 构建系统提示，包含AI名字和预设角色信息
            const systemPrompt = aiPreset;
            
            // 构建API请求体
            const requestBody = {
                model: MODEL_NAME,
                messages: [
                    { role: 'system', content: systemPrompt },
                    ...messageHistory
                ],
                temperature: 0.7,
                max_tokens: 1024
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('API调用错误:', error);
                throw error;
            }
        }
        
        // 显示加载状态
        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message-bubble message-bubble-ai flex items-center justify-center';
            
            // 添加加载动画
            const loadingContent = document.createElement('div');
            loadingContent.className = 'flex space-x-1';
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'w-2 h-2 bg-gray-400 rounded-full animate-bounce';
                dot.style.animationDelay = `${i * 0.2}s`;
                loadingContent.appendChild(dot);
            }
            loadingDiv.appendChild(loadingContent);
            
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return loadingId;
        }
        
        // 移除加载状态
        function removeLoading(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'message-bubble message-bubble-user' : 'message-bubble message-bubble-ai';
            
            // 移除消息中的头像，仅在顶部显示
            
            const textDiv = document.createElement('p');
            textDiv.textContent = text;
            messageDiv.appendChild(textDiv);
            
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'message-timestamp';
            timestampDiv.textContent = getCurrentTime();
            messageDiv.appendChild(timestampDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 添加动画效果
            messageDiv.classList.add('animate-slide-up');
        }
        
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        

    </script>
</body>
</html>