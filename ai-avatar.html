<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>杜岳潼的AI分身</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 百度语音识别SDK -->
    <script src="https://cdn.jsdelivr.net/npm/baidu-aip-sdk@4.16.10/dist/browser/index.js"></script>
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#07C160', // 微信绿
                        secondary: '#E5E5EA',
                        tertiary: '#F2F2F7',
                        textDark: '#1D1D1F',
                        textLight: '#8E8E93',
                        bubbleUser: '#07C160',
                        bubbleAI: '#FFFFFF',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-in-out',
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                    },
                    boxShadow: {
                        'modal': '0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .avatar-circle {
                border-radius: 50%;
                object-fit: cover;
            }
            .avatar-square {
                border-radius: 8px;
                object-fit: cover;
            }
            .message-bubble {
                max-width: 80%;
                padding: 10px 16px;
                border-radius: 18px;
                margin-bottom: 8px;
                position: relative;
                word-break: break-word;
            }
            .message-bubble-user {
                background-color: theme('colors.bubbleUser');
                color: white;
                border-bottom-right-radius: 4px;
                align-self: flex-end;
            }
            .message-bubble-ai {
                background-color: theme('colors.bubbleAI');
                color: theme('colors.textDark');
                border-bottom-left-radius: 4px;
                align-self: flex-start;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            }
            .message-timestamp {
                font-size: 10px;
                margin-top: 4px;
                opacity: 0.7;
                text-align: right;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-textDark min-h-screen">
    <!-- 设置窗口 -->
    <div id="setupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fade-in">
        <div class="bg-white rounded-lg shadow-modal w-full max-w-md mx-4 overflow-hidden">
            <div class="p-6">
                <h2 class="text-2xl font-bold text-center mb-6">你更喜欢称呼杜岳潼的</h2>
                
                <!-- AI名字设置 -->
                <div class="mb-6">
                    <label class="block text-gray-700 font-medium mb-2">名字</label>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <button id="btnChineseName" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                            中文名字 (杜岳潼)
                        </button>
                        <button id="btnEnglishName" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                            英文名字 (Bowen)
                        </button>
                        <button id="btnCustomName" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                            自定义昵称
                        </button>
                    </div>
                    <div id="customNameContainer" class="hidden">
                        <input type="text" id="customNameInput" placeholder="输入自定义昵称" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary">
                    </div>
                </div>
                
                <!-- 开始聊天按钮 -->
                <button id="btnStartChat" class="w-full py-3 bg-primary text-white rounded-md font-medium hover:bg-opacity-90 transition-colors flex items-center justify-center">
                    开始聊天
                    <i class="fa fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 聊天界面 -->
    <div id="chatInterface" class="hidden h-screen flex flex-col max-w-md mx-auto bg-white shadow-lg">
        <!-- 提示信息 -->
        <div class="bg-yellow-50 text-yellow-700 px-4 py-2 text-xs flex items-center justify-center sticky top-0 z-20">
            <i class="fa fa-info-circle mr-1"></i>
            <span>窗口关闭后，AI人格和聊天记录将消失，请珍惜使用</span>
        </div>
        <!-- 聊天头部 -->
        <div class="border-b border-gray-200 p-4 flex items-center justify-between bg-white sticky top-10 z-10">
            <div class="flex items-center">
                <div id="chatAvatar" class="w-10 h-10 rounded-full overflow-hidden mr-3">
                    <img src="image/touxiang.png" 
                         alt="AI头像" class="w-full h-full object-cover">
                </div>
                <div>
                    <h3 id="chatName" class="font-medium">杜岳潼</h3>
                    <p class="text-xs text-gray-500">在线</p>
                </div>
            </div>
        </div>
        
        <!-- 消息区域 -->
        <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto scrollbar-hide bg-gray-50 flex flex-col">
        </div>
        
        <!-- 输入区域 -->
        <div class="border-t border-gray-200 p-4 bg-white sticky bottom-0">
            <div class="flex items-center gap-2">
                <!-- 语音输入按钮 -->
                <button id="voiceButton" class="text-gray-500 hover:text-primary transition-colors relative">
                    <i class="fa fa-microphone text-xl"></i>
                    <span id="voiceStatus" class="absolute -top-2 -right-2 w-4 h-4 rounded-full bg-red-500 hidden"></span>
                </button>
                <div class="relative flex-1">
                    <input type="text" id="messageInput" placeholder="输入消息..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <button id="btnSend" class="w-10 h-10 rounded-full bg-primary text-white flex items-center justify-center hover:bg-opacity-90 transition-colors">
                    <i class="fa fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // API配置
        const API_URL = 'https://api.modelarts-maas.com/v1/chat/completions';
        const MODEL_NAME = 'deepseek-v3.2-exp';
        const API_KEY = 'HEtGqbA-Td1uXAaB6LmvsWIG_cqOLpebxxhOYAAnl9zKwlCjA_K1EYDaPpzDz3YgJGWDXAUWZe6LJerFtlVjXQ';
        
        // 百度语音识别配置
        const BAIDU_APP_ID = '7187093';
        const BAIDU_API_KEY = 'fgF3kVYhDVpwzxaPOiTkdgNk';
        const BAIDU_SECRET_KEY = 'yjd7eOMLPLOY0Qgy5BZnuIkbnAyUzHF3';
        
        // 全局变量
        let aiName = '杜岳潼'; // 默认使用中文名字
        let aiAvatar = 'image/touxiang.png'; // 默认头像路径
        let avatarShape = 'circle'; // 固定为圆形
        let messageHistory = []; // 存储消息历史，用于多轮对话
        let aiPreset = ''; // 将从文件加载
        let isRecording = false;
        let recognition;
        let audioContext;
        let mediaRecorder;
        let audioBlob;
        
        // DOM 元素
        const setupModal = document.getElementById('setupModal');
        const chatInterface = document.getElementById('chatInterface');
        const btnEnglishName = document.getElementById('btnEnglishName');
        const btnChineseName = document.getElementById('btnChineseName');
        const btnCustomName = document.getElementById('btnCustomName');
        const customNameContainer = document.getElementById('customNameContainer');
        const customNameInput = document.getElementById('customNameInput');
        const btnStartChat = document.getElementById('btnStartChat');
        const chatAvatar = document.getElementById('chatAvatar');
        const chatName = document.getElementById('chatName');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const btnSend = document.getElementById('btnSend');
        const voiceButton = document.getElementById('voiceButton');
        const voiceStatus = document.getElementById('voiceStatus');
        
        // 初始化：加载AI预设
        async function loadAiPreset() {
            try {
                const response = await fetch('ai-preset.txt');
                if (!response.ok) {
                    throw new Error('文件加载失败');
                }
                aiPreset = await response.text();
                console.log('AI预设加载成功');
            } catch (error) {
                console.error('加载AI预设失败:', error);
                // 如果文件加载失败，使用一个简短的默认值
                aiPreset = '你现在扮演杜岳潼的角色，请以他的身份进行对话。';
            }
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAiPreset();
            initVoiceRecognition();
        });
        
        // 初始化语音识别
        function initVoiceRecognition() {
            // 注册语音按钮事件
            voiceButton.addEventListener('click', toggleVoiceRecording);
        }
        
        // 切换语音录制状态
        async function toggleVoiceRecording() {
            if (isRecording) {
                // 停止录音
                stopRecording();
            } else {
                // 开始录音
                try {
                    await startRecording();
                } catch (error) {
                    console.error('录音启动失败:', error);
                    addMessage('抱歉，无法访问麦克风，请确保已授予权限。', 'ai');
                }
            }
        }
        
        // 开始录音
        async function startRecording() {
            // 请求麦克风权限
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            // 创建音频上下文和媒体录制器
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const source = audioContext.createMediaStreamSource(stream);
            const destination = audioContext.createMediaStreamDestination();
            source.connect(destination);
            
            mediaRecorder = new MediaRecorder(destination.stream);
            const chunks = [];
            mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(chunks, { type: 'audio/wav' });
                // 录音停止后进行语音识别
                recognizeVoice(audioBlob);
            };
            
            // 开始录制
            mediaRecorder.start();
            isRecording = true;
            
            // 更新UI
            voiceButton.querySelector('i').className = 'fa fa-stop text-xl';
            voiceButton.classList.add('text-red-500');
            voiceStatus.classList.remove('hidden');
            voiceStatus.classList.add('animate-pulse-slow');
            
            // 5分钟后自动停止录音（防止无限录制）
            setTimeout(() => {
                if (isRecording) {
                    stopRecording();
                }
            }, 300000);
        }
        
        // 停止录音
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // 更新UI
                voiceButton.querySelector('i').className = 'fa fa-microphone text-xl';
                voiceButton.classList.remove('text-red-500');
                voiceStatus.classList.add('hidden');
                voiceStatus.classList.remove('animate-pulse-slow');
                
                // 添加正在识别的提示
                addMessage('正在识别语音...', 'ai');
            }
        }
        
        // 语音识别
        async function recognizeVoice(blob) {
            try {
                // 先移除"正在识别"的提示
                const messages = messagesContainer.querySelectorAll('.message-bubble');
                if (messages.length > 0 && messages[messages.length - 1].textContent.includes('正在识别语音...')) {
                    messages[messages.length - 1].remove();
                }
                
                // 转换音频格式为PCM
                const arrayBuffer = await blob.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                // 重采样为16000Hz，单声道，16位
                const resampledBuffer = resampleAudio(audioBuffer, 16000);
                const pcmData = convertTo16BitPCM(resampledBuffer);
                
                // 获取百度AccessToken
                const token = await getBaiduAccessToken();
                
                // 调用百度语音识别API
                const result = await callBaiduASR(pcmData, token);
                
                if (result && result.result && result.result.length > 0) {
                    const text = result.result[0];
                    // 将识别结果填入输入框并发送
                    messageInput.value = text;
                    sendMessage();
                } else {
                    addMessage('抱歉，未能识别到语音，请重试。', 'ai');
                }
            } catch (error) {
                console.error('语音识别失败:', error);
                addMessage('语音识别失败，请重试。', 'ai');
            }
        }
        
        // 获取百度AccessToken
        async function getBaiduAccessToken() {
            const url = `https://aip.baidubce.com/oauth/2.0/token?grant_type=client_credentials&client_id=${BAIDU_API_KEY}&client_secret=${BAIDU_SECRET_KEY}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            });
            
            const data = await response.json();
            return data.access_token;
        }
        
        // 调用百度语音识别API
        async function callBaiduASR(pcmData, token) {
            const url = `https://vop.baidu.com/server_api?dev_pid=1537&cuid=baidu_speech_demo&token=${token}`;
            
            // 对PCM数据进行base64编码
            const base64Data = btoa(String.fromCharCode(...new Uint8Array(pcmData)));
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    format: 'pcm',
                    rate: 16000,
                    channel: 1,
                    cuid: 'baidu_speech_demo',
                    token: token,
                    speech: base64Data,
                    len: pcmData.byteLength
                })
            });
            
            return await response.json();
        }
        
        // 音频重采样
        function resampleAudio(audioBuffer, targetSampleRate) {
            const sourceSampleRate = audioBuffer.sampleRate;
            const sourceChannels = audioBuffer.numberOfChannels;
            
            // 如果采样率已经是目标采样率，直接返回
            if (sourceSampleRate === targetSampleRate) {
                return audioBuffer;
            }
            
            // 计算重采样后的长度
            const length = Math.floor(audioBuffer.length * targetSampleRate / sourceSampleRate);
            const offlineContext = new OfflineAudioContext(1, length, targetSampleRate);
            const bufferSource = offlineContext.createBufferSource();
            
            // 合并为单声道
            const monoBuffer = offlineContext.createBuffer(1, audioBuffer.length, sourceSampleRate);
            const leftChannel = audioBuffer.getChannelData(0);
            const rightChannel = sourceChannels > 1 ? audioBuffer.getChannelData(1) : leftChannel;
            const monoData = monoBuffer.getChannelData(0);
            
            for (let i = 0; i < monoData.length; i++) {
                monoData[i] = (leftChannel[i] + rightChannel[i]) / 2;
            }
            
            bufferSource.buffer = monoBuffer;
            bufferSource.connect(offlineContext.destination);
            bufferSource.start(0);
            
            return new Promise((resolve) => {
                offlineContext.startRendering().then(resolvedBuffer => {
                    resolve(resolvedBuffer);
                });
            });
        }
        
        // 转换为16位PCM
        function convertTo16BitPCM(audioBuffer) {
            const data = audioBuffer.getChannelData(0);
            const buffer = new ArrayBuffer(data.length * 2);
            const view = new DataView(buffer);
            
            for (let i = 0; i < data.length; i++) {
                const value = Math.max(-1, Math.min(1, data[i]));
                view.setInt16(i * 2, value < 0 ? value * 0x8000 : value * 0x7FFF, true);
            }
            
            return buffer;
        }
        
        // 名字选择按钮事件
        btnEnglishName.addEventListener('click', () => {
            aiName = 'Bowen';
            updateNameButtons(btnEnglishName);
            customNameContainer.classList.add('hidden');
        });
        
        btnChineseName.addEventListener('click', () => {
            aiName = '杜岳潼';
            updateNameButtons(btnChineseName);
            customNameContainer.classList.add('hidden');
        });
        
        btnCustomName.addEventListener('click', () => {
            updateNameButtons(btnCustomName);
            customNameContainer.classList.remove('hidden');
            customNameInput.focus();
        });
        
        // 自定义名字输入事件
        customNameInput.addEventListener('input', (e) => {
            if (e.target.value.trim()) {
                aiName = e.target.value.trim();
            }
        });
        
        // 开始聊天按钮事件
        btnStartChat.addEventListener('click', () => {
            setupModal.classList.add('hidden');
            chatInterface.classList.remove('hidden');
            
            // 更新聊天界面的头像和名字
            chatName.textContent = aiName;
            chatAvatar.innerHTML = `<img src="${aiAvatar}" alt="${aiName}" class="w-full h-full object-cover">`;
            chatAvatar.className = 'w-10 h-10 rounded-full overflow-hidden mr-3'; // 固定为圆形
            
            // 清除消息历史
            messageHistory = [];
            
            // 清除消息区域
            messagesContainer.innerHTML = '';
            
            // 添加欢迎消息（符合角色设定）
            const welcomeMessage = `嗨，我是${aiName}。网上聊天我比较自在，有什么想聊的吗？`;
            addMessage(welcomeMessage, 'ai');
            
            // 添加欢迎消息到历史记录
            messageHistory.push({
                role: 'assistant',
                content: welcomeMessage
            });
            
            // 聚焦到输入框
            messageInput.focus();
        });
        
        // 发送按钮事件
        btnSend.addEventListener('click', sendMessage);
        
        // 输入框回车事件
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 辅助函数
        function updateNameButtons(activeButton) {
            const buttons = [btnEnglishName, btnChineseName, btnCustomName];
            buttons.forEach(btn => {
                if (btn === activeButton) {
                    btn.classList.remove('bg-gray-200', 'text-gray-700');
                    btn.classList.add('bg-primary', 'text-white');
                } else {
                    btn.classList.remove('bg-primary', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
        }
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // 添加用户消息
            addMessage(message, 'user');
            messageInput.value = '';
            
            // 添加到消息历史
            messageHistory.push({
                role: 'user',
                content: message
            });
            
            // 显示加载状态
            const loadingId = showLoading();
            
            // 调用API获取AI回复
            callApi(message)
                .then(response => {
                    // 移除加载状态
                    removeLoading(loadingId);
                    
                    // 添加AI回复
                    addMessage(response, 'ai');
                    
                    // 添加到消息历史
                    messageHistory.push({
                        role: 'assistant',
                        content: response
                    });
                })
                .catch(error => {
                    // 移除加载状态
                    removeLoading(loadingId);
                    
                    // 显示错误消息
                    addMessage('抱歉，API调用失败，请稍后再试。', 'ai');
                    console.error('API调用失败:', error);
                });
        }
        
        // 调用API获取AI回复
        async function callApi(message) {
            // 检查aiPreset是否已加载
            if (!aiPreset) {
                console.warn('AI预设尚未加载完成，等待中...');
                // 等待一小段时间再重试
                await new Promise(resolve => setTimeout(resolve, 100));
                if (!aiPreset) {
                    throw new Error('AI预设加载失败，请刷新页面重试');
                }
            }
            
            // 构建系统提示，包含AI名字和预设角色信息
            const systemPrompt = aiPreset;
            
            // 构建API请求体
            const requestBody = {
                model: MODEL_NAME,
                messages: [
                    { role: 'system', content: systemPrompt },
                    ...messageHistory
                ],
                temperature: 0.7,
                max_tokens: 1024
            };
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error('API调用错误:', error);
                throw error;
            }
        }
        
        // 显示加载状态
        function showLoading() {
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'message-bubble message-bubble-ai flex items-center justify-center';
            
            // 添加加载动画
            const loadingContent = document.createElement('div');
            loadingContent.className = 'flex space-x-1';
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'w-2 h-2 bg-gray-400 rounded-full animate-bounce';
                dot.style.animationDelay = `${i * 0.2}s`;
                loadingContent.appendChild(dot);
            }
            loadingDiv.appendChild(loadingContent);
            
            messagesContainer.appendChild(loadingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return loadingId;
        }
        
        // 移除加载状态
        function removeLoading(loadingId) {
            const loadingDiv = document.getElementById(loadingId);
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }
        
        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'message-bubble message-bubble-user' : 'message-bubble message-bubble-ai';
            
            const textDiv = document.createElement('p');
            textDiv.textContent = text;
            messageDiv.appendChild(textDiv);
            
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'message-timestamp';
            timestampDiv.textContent = getCurrentTime();
            messageDiv.appendChild(timestampDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 添加动画效果
            messageDiv.classList.add('animate-slide-up');
        }
        
        function getCurrentTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
    </script>
</body>
</html>
